<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>J.A.R.V.I.S. System</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { jarvis: '#f97316', dark: '#050505', glass: 'rgba(20, 20, 20, 0.7)' },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    
    <style>
        /* Estilos Globais e Reset */
        body { background-color: #000; color: #eee; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        
        /* Efeito Vidro */
        .glass-panel {
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* Scrollbar Invis√≠vel */
        .no-scroll::-webkit-scrollbar { display: none; }
        .no-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Input Elevado */
        .input-area {
            padding-bottom: env(safe-area-inset-bottom, 20px);
            position: absolute; bottom: 0; left: 0; width: 100%;
        }
        
        /* Canvas de Fundo */
        #fire-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- COMPONENTE: PARTICULAS DE FOGO (CANVAS) ---
        const FireBackground = () => {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let width, height, particles = [];

                const resize = () => {
                    width = canvas.width = window.innerWidth;
                    height = canvas.height = window.innerHeight;
                };
                window.addEventListener('resize', resize);
                resize();

                class Particle {
                    constructor() {
                        this.reset();
                    }
                    reset() {
                        this.x = Math.random() * width;
                        this.y = height + Math.random() * 100;
                        this.speed = 1 + Math.random() * 2;
                        this.size = 1 + Math.random() * 3;
                        this.opacity = 0.5 + Math.random() * 0.5;
                        this.fade = 0.002 + Math.random() * 0.005;
                    }
                    update() {
                        this.y -= this.speed;
                        this.opacity -= this.fade;
                        if (this.opacity <= 0) this.reset();
                    }
                    draw() {
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(249, 115, 22, ${this.opacity})`; // Cor Laranja Jarvis
                        ctx.fill();
                    }
                }

                for(let i=0; i<60; i++) particles.push(new Particle());

                const animate = () => {
                    ctx.clearRect(0, 0, width, height);
                    particles.forEach(p => { p.update(); p.draw(); });
                    requestAnimationFrame(animate);
                };
                animate();
            }, []);

            return <canvas id="fire-canvas" ref={canvasRef}></canvas>;
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            // Estado de Autentica√ß√£o Persistente
            const [isAuth, setIsAuth] = useState(localStorage.getItem('jarvis_token') === 'true');
            
            // Estados do Chat
            const [step, setStep] = useState(1); // 1: Fone, 2: Codigo
            const [phone, setPhone] = useState('');
            const [code, setCode] = useState('');
            const [loading, setLoading] = useState(false);
            
            const [messages, setMessages] = useState([{ type: 'bot', text: 'Sistemas online. J.A.R.V.I.S. pronto.' }]);
            const [input, setInput] = useState('');
            const [listening, setListening] = useState(false);
            const [cameraOpen, setCameraOpen] = useState(false);
            
            const videoRef = useRef();
            const canvasRef = useRef();
            const msgEndRef = useRef();

            useEffect(() => { msgEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            // --- FUN√á√ïES DE AUTH ---
            const handleLogin = async () => {
                if (step === 1) {
                    setLoading(true);
                    try {
                        await fetch('./auth/send_code', { 
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ phone }) 
                        });
                        setStep(2);
                    } catch(e) { alert("Erro ao enviar SMS"); }
                    setLoading(false);
                } else {
                    setLoading(true);
                    try {
                        const res = await fetch('./auth/login', { 
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ code }) 
                        });
                        const data = await res.json();
                        if (data.status === 'success' || data.session) {
                            localStorage.setItem('jarvis_token', 'true');
                            setIsAuth(true);
                        } else { alert("C√≥digo inv√°lido"); }
                    } catch(e) { alert("Erro ao logar"); }
                    setLoading(false);
                }
            };

            // --- FUN√á√ïES DE CHAT ---
            const sendMessage = async (txt) => {
                const textToSend = txt || input;
                if (!textToSend.trim()) return;

                setMessages(prev => [...prev, { type: 'user', text: textToSend }]);
                setInput('');

                try {
                    const res = await fetch('./perguntar', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ pergunta: textToSend })
                    });
                    const data = await res.json();
                    setMessages(prev => [...prev, { type: 'bot', text: data.resposta }]);
                } catch {
                    setMessages(prev => [...prev, { type: 'bot', text: 'Erro de conex√£o com o servidor.' }]);
                }
            };

            const toggleMic = () => {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Speech) return alert("Navegador sem suporte a voz.");
                
                const rec = new Speech();
                rec.lang = 'pt-BR';
                rec.onstart = () => setListening(true);
                rec.onresult = (e) => {
                    const t = e.results[0][0].transcript;
                    setInput(t);
                    setTimeout(() => sendMessage(t), 2500); // Envia ap√≥s 2.5s
                };
                rec.onend = () => setListening(false);
                rec.start();
            };

            // --- C√ÇMERA ---
            const toggleCamera = async () => {
                if (!cameraOpen) {
                    setCameraOpen(true);
                    await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    // Pequeno delay para garantir que o elemento video existe no DOM
                    setTimeout(() => { if(videoRef.current) videoRef.current.srcObject = stream; }, 100);
                } else {
                    setCameraOpen(false);
                }
            };

            const handleVideoPlay = () => {
                setInterval(async () => {
                    if (videoRef.current && canvasRef.current) {
                        const displaySize = { width: videoRef.current.videoWidth, height: videoRef.current.videoHeight };
                        faceapi.matchDimensions(canvasRef.current, displaySize);
                        const detections = await faceapi.detectAllFaces(videoRef.current, new faceapi.TinyFaceDetectorOptions());
                        const resized = faceapi.resizeResults(detections, displaySize);
                        const ctx = canvasRef.current.getContext('2d');
                        ctx.clearRect(0, 0, displaySize.width, displaySize.height);
                        faceapi.draw.drawDetections(canvasRef.current, resized);
                    }
                }, 200);
            };

            // --- RENDERIZA√á√ÉO: TELA DE LOGIN ---
            if (!isAuth) return (
                <>
                    <FireBackground />
                    <div className="flex items-center justify-center h-screen px-6">
                        <div className="glass-panel w-full max-w-sm p-8 rounded-3xl animate-fade-in text-center">
                            <div className="w-16 h-16 bg-jarvis/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-jarvis/50 animate-pulse-slow">
                                <span className="text-2xl">üî•</span>
                            </div>
                            <h1 className="text-3xl font-bold mb-2 tracking-tighter">J.A.R.V.I.S.</h1>
                            <p className="text-gray-400 text-sm mb-8">Protocolo de Acesso Seguro</p>

                            <div className="space-y-4">
                                {step === 1 ? (
                                    <input 
                                        className="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-center text-white outline-none focus:border-jarvis transition-colors"
                                        placeholder="+5511999999999"
                                        value={phone} onChange={e => setPhone(e.target.value)}
                                    />
                                ) : (
                                    <input 
                                        className="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-center text-white outline-none focus:border-jarvis transition-colors tracking-widest text-xl"
                                        placeholder="12345"
                                        type="number"
                                        value={code} onChange={e => setCode(e.target.value)}
                                    />
                                )}
                                
                                <button 
                                    onClick={handleLogin}
                                    disabled={loading}
                                    className="w-full bg-jarvis hover:bg-orange-700 text-white font-bold p-4 rounded-xl transition-all active:scale-95 shadow-lg shadow-orange-900/30"
                                >
                                    {loading ? 'Processando...' : (step === 1 ? 'Iniciar Conex√£o' : 'Autenticar')}
                                </button>
                            </div>
                        </div>
                    </div>
                </>
            );

            // --- RENDERIZA√á√ÉO: CHAT (APP) ---
            return (
                <div className="flex flex-col h-screen relative">
                    <FireBackground />
                    
                    {/* Header */}
                    <header className="glass-panel p-4 flex justify-between items-center z-20 sticky top-0">
                        <div className="flex items-center gap-3">
                            <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <h1 className="font-bold tracking-widest text-lg">JARVIS.AI</h1>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={() => {localStorage.clear(); window.location.reload()}} className="text-xs text-gray-500 border border-white/10 px-3 py-1 rounded-full">Sair</button>
                            <button onClick={toggleCamera} className={`p-2 rounded-full ${cameraOpen ? 'bg-red-600' : 'bg-white/10'}`}>üì∑</button>
                        </div>
                    </header>

                    {/* Camera Overlay */}
                    {cameraOpen && (
                        <div className="fixed inset-0 z-30 bg-black flex items-center justify-center">
                            <video ref={videoRef} autoPlay muted playsInline onPlay={handleVideoPlay} className="w-full h-full object-cover"></video>
                            <canvas ref={canvasRef} className="absolute inset-0 w-full h-full"></canvas>
                            <button onClick={() => setCameraOpen(false)} className="absolute top-6 right-6 z-40 bg-red-600 p-3 rounded-full shadow-lg font-bold">FECHAR X</button>
                        </div>
                    )}

                    {/* Chat Body */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-6 pb-32 no-scroll">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-4 rounded-2xl shadow-md text-sm md:text-base leading-relaxed ${
                                    m.type === 'user' 
                                    ? 'bg-jarvis text-white rounded-tr-none' 
                                    : 'glass-panel text-gray-200 rounded-tl-none border-l-2 border-jarvis'
                                }`}>
                                    {m.text}
                                </div>
                            </div>
                        ))}
                        <div ref={msgEndRef} />
                    </div>

                    {/* Input Area (Elevada) */}
                    <div className="input-area z-20 px-4 pb-6">
                        <div className="glass-panel p-2 rounded-3xl flex items-center gap-2 shadow-2xl">
                            <button 
                                onClick={toggleMic}
                                className={`p-4 rounded-full transition-all ${listening ? 'bg-red-600 animate-pulse' : 'bg-white/5 text-gray-400'}`}
                            >
                                üéôÔ∏è
                            </button>
                            
                            <input 
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyPress={e => e.key === 'Enter' && sendMessage()}
                                placeholder="Comando ou pergunta..."
                                className="flex-1 bg-transparent text-white outline-none px-2 placeholder-gray-500"
                            />
                            
                            <button 
                                onClick={() => sendMessage()}
                                className="bg-jarvis p-4 rounded-full text-white shadow-lg active:scale-90 transition-transform"
                            >
                                ‚û§
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
