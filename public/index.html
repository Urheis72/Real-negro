<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JARVIS SYSTEM</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background-color: #000000;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* Animação de Fundo CSS (Substituindo o Canvas para evitar bugs) */
        .bg-grid {
            position: fixed;
            top: 0; left: 0; width: 200%; height: 200%;
            background-image: 
                linear-gradient(rgba(255, 165, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 165, 0, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: moveGrid 20s linear infinite;
            z-index: -1;
            pointer-events: none;
        }

        @keyframes moveGrid {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-40px, -40px); }
        }

        /* Efeito de Vidro */
        .glass {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(249, 115, 22, 0.3);
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.1);
        }

        /* Input Glow */
        .jarvis-input:focus {
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.4);
            border-color: #f97316;
        }
        
        /* Loading Text Fallback */
        #loader {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #f97316; font-size: 14px; letter-spacing: 2px;
        }
    </style>
</head>
<body>

    <div class="bg-grid"></div>

    <div id="root">
        <div id="loader">CARREGANDO SISTEMA JARVIS...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- TELA DE LOGIN ---
        const AuthScreen = ({ onLogin }) => {
            const [step, setStep] = useState(1);
            const [phone, setPhone] = useState('');
            const [code, setCode] = useState('');
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState('');

            const sendPhone = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMsg('');
                try {
                    const res = await fetch('./auth/send_code', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ phone })
                    });
                    const data = await res.json();
                    if(data.status === 'sent') setStep(2);
                    else setMsg('Erro: Verifique o número');
                } catch(err) {
                    setMsg('Erro de conexão com o servidor');
                }
                setLoading(false);
            };

            const verifyCode = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const res = await fetch('./auth/login', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ code })
                    });
                    const data = await res.json();
                    if(data.status === 'success' || data.session_string) {
                        localStorage.setItem('jarvis_auth', 'true');
                        onLogin();
                    } else {
                        setMsg('Código inválido');
                    }
                } catch(err) {
                    setMsg('Erro ao validar');
                }
                setLoading(false);
            };

            return (
                <div className="flex items-center justify-center h-screen p-6">
                    <div className="glass w-full max-w-sm p-8 rounded-xl animate-pulse-slow">
                        <h1 className="text-3xl font-bold text-orange-500 text-center mb-2 tracking-widest">JARVIS</h1>
                        <p className="text-gray-500 text-center text-xs mb-8">SECURE LOGIN PROTOCOL</p>

                        {msg && <div className="text-red-400 text-xs text-center mb-4 border border-red-900 p-2">{msg}</div>}

                        {step === 1 ? (
                            <form onSubmit={sendPhone}>
                                <label className="text-orange-500 text-xs font-bold">TELEFONE</label>
                                <input 
                                    type="tel" 
                                    placeholder="+55..." 
                                    value={phone}
                                    onChange={e => setPhone(e.target.value)}
                                    className="w-full bg-black border border-gray-700 text-white p-3 rounded mt-2 mb-6 outline-none jarvis-input"
                                />
                                <button disabled={loading} className="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded transition-all">
                                    {loading ? 'ENVIANDO...' : 'CONECTAR'}
                                </button>
                            </form>
                        ) : (
                            <form onSubmit={verifyCode}>
                                <label className="text-orange-500 text-xs font-bold">CÓDIGO DE ACESSO</label>
                                <input 
                                    type="number" 
                                    placeholder="00000" 
                                    value={code}
                                    onChange={e => setCode(e.target.value)}
                                    className="w-full bg-black border border-gray-700 text-white p-3 rounded mt-2 mb-6 outline-none jarvis-input text-center text-xl tracking-widest"
                                />
                                <button disabled={loading} className="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded transition-all">
                                    {loading ? 'VALIDANDO...' : 'ENTRAR'}
                                </button>
                                <button type="button" onClick={() => setStep(1)} className="w-full text-gray-500 text-xs mt-4 underline">Voltar</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        // --- TELA DE CHAT ---
        const ChatScreen = ({ onLogout }) => {
            const [msgs, setMsgs] = useState([{ type: 'bot', text: 'Sistemas online. Como posso ajudar?' }]);
            const [input, setInput] = useState('');
            const endRef = useRef(null);

            useEffect(() => endRef.current?.scrollIntoView({ behavior: 'smooth' }), [msgs]);

            const send = async () => {
                if(!input.trim()) return;
                const txt = input;
                setMsgs(p => [...p, { type: 'user', text: txt }]);
                setInput('');

                try {
                    const res = await fetch('./perguntar', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ pergunta: txt })
                    });
                    const data = await res.json();
                    setMsgs(p => [...p, { type: 'bot', text: data.resposta }]);
                } catch(e) {
                    setMsgs(p => [...p, { type: 'bot', text: 'Erro de conexão com o servidor.' }]);
                }
            };

            return (
                <div className="flex flex-col h-screen">
                    {/* Header */}
                    <header className="glass p-4 flex justify-between items-center z-10">
                        <div className="flex items-center gap-2">
                            <div className="w-3 h-3 bg-orange-500 rounded-full animate-pulse"></div>
                            <span className="font-bold text-orange-500 tracking-widest">JARVIS</span>
                        </div>
                        <button onClick={onLogout} className="text-xs text-gray-400 hover:text-white border border-gray-700 px-3 py-1 rounded">SAIR</button>
                    </header>

                    {/* Mensagens */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {msgs.map((m, i) => (
                            <div key={i} className={`flex ${m.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`p-4 rounded-xl max-w-[85%] text-sm ${m.type === 'user' ? 'bg-orange-600 text-white' : 'glass text-gray-200'}`}>
                                    {m.text}
                                </div>
                            </div>
                        ))}
                        <div ref={endRef}></div>
                    </div>

                    {/* Input */}
                    <div className="p-4 glass pb-8">
                        <div className="flex gap-2">
                            <input 
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && send()}
                                placeholder="Digite um comando..."
                                className="flex-1 bg-black/50 border border-gray-700 rounded-lg p-4 text-white outline-none jarvis-input"
                            />
                            <button onClick={send} className="bg-orange-600 px-6 rounded-lg font-bold text-white hover:bg-orange-500">➤</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [isAuth, setIsAuth] = useState(false);
            const [mounted, setMounted] = useState(false);

            useEffect(() => {
                setMounted(true); // Garante que o React montou
                if(localStorage.getItem('jarvis_auth') === 'true') {
                    setIsAuth(true);
                }
            }, []);

            if(!mounted) return null;

            return isAuth 
                ? <ChatScreen onLogout={() => { localStorage.removeItem('jarvis_auth'); setIsAuth(false); }} /> 
                : <AuthScreen onLogin={() => setIsAuth(true)} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
