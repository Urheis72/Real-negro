<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        #camera-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto; display: none; }
        video { width: 100%; border-radius: 12px; }
        canvas { position: absolute; top: 0; left: 0; }
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 12px; margin-bottom: 10px; }
        .user-msg { background-color: #3b82f6; align-self: flex-end; }
        .bot-msg { background-color: #1e293b; align-self: flex-start; border: 1px solid #334155; }
    </style>
</head>
<body class="h-screen flex flex-col items-center">

    <header class="w-full p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
        <h1 class="text-xl font-bold text-blue-400">J.A.R.V.I.S.</h1>
        <button onclick="toggleCamera()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">
            ðŸ“· CÃ¢mera
        </button>
    </header>

    <div id="camera-container" class="mt-4">
        <video id="video" autoplay muted></video>
        <canvas id="overlay"></canvas>
    </div>

    <div id="chat-box" class="flex-1 w-full max-w-lg p-4 overflow-y-auto flex flex-col">
        <div class="bot-msg chat-bubble">
            OlÃ¡. Sou o Jarvis. Use comandos (/) para Telegram ou fale naturalmente.
        </div>
    </div>

    <div class="w-full max-w-lg p-4 bg-slate-900">
        <form id="chat-form" class="flex gap-2">
            <input type="text" id="msg-input" placeholder="Digite aqui..." 
                   class="flex-1 bg-slate-800 text-white p-3 rounded-lg border border-slate-700 focus:outline-none focus:border-blue-500">
            <button type="submit" class="bg-blue-600 px-6 py-2 rounded-lg font-bold">Enviar</button>
        </form>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('msg-input');
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const cameraContainer = document.getElementById('camera-container');

        let isCameraOn = false;
        let detectedFaces = new Map(); // Store face IDs
        let nextFaceId = 1;

        // --- AUDIO PLAYER ---
        function playAudio(base64Audio) {
            if (!base64Audio) return;
            const audio = new Audio("data:audio/mp3;base64," + base64Audio);
            audio.play().catch(e => console.log("Audio autoplay blocked:", e));
        }

        // --- CHAT LOGIC ---
        function addMessage(text, isUser) {
            const div = document.createElement('div');
            div.className = `chat-bubble ${isUser ? 'user-msg' : 'bot-msg'}`;
            div.innerText = text; // Safe text insertion
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, true);
            input.value = '';

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: text, session_id: 'user-1' })
                });
                const data = await res.json();
                
                addMessage(data.text, false);
                if (data.audio) playAudio(data.audio);

            } catch (err) {
                addMessage("Erro de conexÃ£o.", false);
            }
        };

        // --- CAMERA & FACE RECOGNITION LOGIC ---
        async function loadModels() {
            // Loading models from a public CDN for ease of use
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
        }

        async function toggleCamera() {
            if (isCameraOn) {
                video.srcObject.getTracks().forEach(track => track.stop());
                cameraContainer.style.display = 'none';
                isCameraOn = false;
            } else {
                cameraContainer.style.display = 'block';
                await loadModels();
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                isCameraOn = true;
                detectFaces();
            }
        }

        async function detectFaces() {
            if (!isCameraOn) return;

            const displaySize = { width: video.videoWidth || 300, height: video.videoHeight || 200 };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                resizedDetections.forEach(det => {
                    const box = det.box;
                    
                    // Simple logic: If face is detected, assign ID (in real app, use descriptors)
                    // Here we just visualize "Face 1" for the first detection in frame
                    
                    // Draw Box
                    ctx.strokeStyle = '#ef4444'; // Red-500
                    ctx.lineWidth = 3;
                    ctx.strokeRect(box.x, box.y, box.width, box.height);

                    // Draw Label
                    ctx.fillStyle = '#ef4444';
                    ctx.fillRect(box.x, box.y - 30, box.width, 30);
                    ctx.fillStyle = 'white';
                    ctx.font = '16px Arial';
                    ctx.fillText(`Face ${nextFaceId}`, box.x + 5, box.y - 10);
                    
                    // Capture Logic (Once per session per face)
                    if (!detectedFaces.has(nextFaceId)) {
                        detectedFaces.set(nextFaceId, true);
                        takeSnapshot();
                    }
                });
            }, 500);
        }

        function takeSnapshot() {
            // Capture logic
            const capCanvas = document.createElement('canvas');
            capCanvas.width = video.videoWidth;
            capCanvas.height = video.videoHeight;
            capCanvas.getContext('2d').drawImage(video, 0, 0);
            
            // Send to backend (Silent upload)
            capCanvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('image', blob);
                fetch('/upload_face', { method: 'POST', body: formData });
                console.log("ðŸ“¸ Face captured and sent.");
            });
        }
    </script>
</body>
</html>
