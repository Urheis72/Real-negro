<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jarvis Interface</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS GERAIS --- */
        body { 
            background: #050505; 
            color: #e5e5e5; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; /* Impede scroll na p√°gina inteira */
        }
        
        /* Fundo de part√≠culas */
        #canvas-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* Scrollbar invis√≠vel mas funcional */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Efeito de Vidro (Glassmorphism) */
        .glass {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Anima√ß√µes de Entrada */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        /* Ajustes de Input */
        input:focus { outline: none; border-color: #f97316; box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.2); }
        
        /* Fonte mono para dados t√©cnicos */
        .font-tech { font-family: 'Roboto Mono', monospace; }

        /* Camada da c√¢mera */
        .cam-layer { position: fixed; inset: 0; z-index: 50; background: black; display: flex; flex-direction: column; }
    </style>
</head>
<body>
    <canvas id="canvas-bg"></canvas>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- COMPONENTE: FUNDO DE BRASAS (CANVAS) ---
        const ParticleBackground = () => {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let width = canvas.width = window.innerWidth;
                let height = canvas.height = window.innerHeight;
                let particles = [];

                class Particle {
                    constructor() {
                        this.x = Math.random() * width;
                        this.y = height + Math.random() * 100;
                        this.vx = (Math.random() - 0.5) * 0.5;
                        this.vy = Math.random() * -1 - 0.5;
                        this.size = Math.random() * 2 + 0.5;
                        this.alpha = Math.random() * 0.5 + 0.1;
                    }
                    update() {
                        this.x += this.vx;
                        this.y += this.vy;
                        this.alpha -= 0.002;
                        if (this.alpha <= 0) this.reset();
                    }
                    reset() {
                        this.x = Math.random() * width;
                        this.y = height + Math.random() * 50;
                        this.alpha = Math.random() * 0.5 + 0.3;
                    }
                    draw() {
                        ctx.globalAlpha = this.alpha;
                        ctx.fillStyle = '#ea580c'; // Orange-600
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                for(let i=0; i<60; i++) particles.push(new Particle());

                const animate = () => {
                    ctx.clearRect(0, 0, width, height);
                    particles.forEach(p => { p.update(); p.draw(); });
                    requestAnimationFrame(animate);
                };
                animate();

                const handleResize = () => { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            return <canvas ref={canvasRef} id="canvas-bg" />;
        };

        // --- COMPONENTE: APP PRINCIPAL ---
        function App() {
            // Estado de Autentica√ß√£o
            const [isAuth, setIsAuth] = useState(localStorage.getItem('jarvis_auth_v2') === 'true');
            
            // Estados do Chat
            const [msg, setMsg] = useState([{ t: 'a', m: 'Sistemas online. Como posso ajudar?' }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [listening, setListening] = useState(false);
            
            // Estados da C√¢mera
            const [showCam, setShowCam] = useState(false);
            const videoRef = useRef();
            const canvasRef = useRef();
            
            // Refs
            const msgEndRef = useRef(null);
            const silenceTimer = useRef(null);

            // Scroll autom√°tico
            useEffect(() => { msgEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [msg]);

            // --- L√ìGICA DE LOGIN ---
            const [loginStep, setLoginStep] = useState(1);
            const [phone, setPhone] = useState('');
            const [code, setCode] = useState('');
            const [loginLoading, setLoginLoading] = useState(false);

            const handleLogin = async (type) => {
                setLoginLoading(true);
                try {
                    const endpoint = type === 'phone' ? './auth/send_code' : './auth/login';
                    const body = type === 'phone' ? { phone } : { code };
                    
                    const res = await fetch(endpoint, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
                    });
                    const data = await res.json();

                    if (type === 'phone') {
                        if (data.status === 'sent') setLoginStep(2);
                        else alert('Erro ao enviar SMS.');
                    } else {
                        if (data.status === 'success' || data.session_string) {
                            localStorage.setItem('jarvis_auth_v2', 'true');
                            setIsAuth(true);
                        } else {
                            alert('C√≥digo inv√°lido ou senha 2FA necess√°ria (n√£o implementada nesta UI simplificada).');
                        }
                    }
                } catch (e) { alert("Erro de conex√£o com o servidor."); }
                setLoginLoading(false);
            };

            // --- L√ìGICA DE CHAT ---
            const send = async (txt) => {
                const val = txt || input;
                if (!val.trim() || loading) return;
                
                const newMsgs = [...msg, { t: 'u', m: val }];
                setMsg(newMsgs);
                setInput('');
                setLoading(true);

                try {
                    const res = await fetch('./perguntar', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ pergunta: val })
                    });
                    const data = await res.json();
                    setMsg([...newMsgs, { t: 'a', m: data.resposta }]);
                } catch {
                    setMsg([...newMsgs, { t: 'a', m: "Erro de conex√£o com a IA." }]);
                }
                setLoading(false);
            };

            // --- L√ìGICA DE VOZ ---
            const toggleMic = () => {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Speech) return alert("Navegador sem suporte a voz.");
                
                if (listening) return; // Evita duplo clique

                const rec = new Speech();
                rec.lang = 'pt-BR';
                rec.continuous = true;
                rec.interimResults = true;

                rec.onstart = () => setListening(true);
                rec.onresult = (e) => {
                    const text = Array.from(e.results).map(r => r[0].transcript).join('');
                    setInput(text);
                    
                    if (silenceTimer.current) clearTimeout(silenceTimer.current);
                    silenceTimer.current = setTimeout(() => { 
                        rec.stop(); 
                        send(text); 
                    }, 2500); // 2.5s de sil√™ncio envia
                };
                rec.onend = () => setListening(false);
                rec.start();
            };

            // --- L√ìGICA DE C√ÇMERA ---
            const openCam = async () => {
                setShowCam(true);
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    if(videoRef.current) videoRef.current.srcObject = stream;
                } catch(e) { alert("Erro ao abrir c√¢mera: " + e); setShowCam(false); }
            };

            const handleVideoPlay = () => {
                const vid = videoRef.current;
                const cvs = canvasRef.current;
                if (!vid || !cvs) return;

                const displaySize = { width: vid.videoWidth, height: vid.videoHeight };
                faceapi.matchDimensions(cvs, displaySize);

                const interval = setInterval(async () => {
                    if (!vid || vid.paused || vid.ended) return clearInterval(interval);
                    const detections = await faceapi.detectAllFaces(vid, new faceapi.TinyFaceDetectorOptions());
                    const resized = faceapi.resizeResults(detections, displaySize);
                    const ctx = cvs.getContext('2d');
                    ctx.clearRect(0, 0, cvs.width, cvs.height);
                    
                    // Desenho customizado dos quadrados
                    resized.forEach((det, i) => {
                        const box = det.box;
                        ctx.strokeStyle = '#ea580c'; // Orange
                        ctx.lineWidth = 3;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);
                        
                        ctx.fillStyle = '#ea580c';
                        ctx.font = '16px Roboto Mono';
                        ctx.fillText(`ID: ${i + 1}`, box.x, box.y - 10);
                    });
                }, 200);
            };

            // --- RENDER: TELA DE LOGIN ---
            if (!isAuth) {
                return (
                    <div className="flex items-center justify-center min-h-screen p-6 relative">
                        <ParticleBackground />
                        <div className="glass w-full max-w-md p-8 rounded-3xl animate-enter border border-orange-500/20">
                            <div className="flex justify-center mb-8">
                                <div className="w-16 h-16 rounded-full bg-orange-500/10 flex items-center justify-center border border-orange-500 shadow-[0_0_15px_rgba(234,88,12,0.3)]">
                                    <svg className="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.131A8 8 0 008 8m0 0a8 8 0 00-8 8c0 2.472.345 4.865.99 7.131M8 2.88c0 .995-.41 1.89-1.08 2.522M20.92 5.402a4.004 4.004 0 01-1.08-2.522" /></svg>
                                </div>
                            </div>
                            
                            <h2 className="text-2xl font-bold text-center mb-1 tracking-wider">JARVIS <span className="text-orange-500">ACCESS</span></h2>
                            <p className="text-center text-gray-400 text-sm mb-8 font-tech">SECURE CONNECTION REQUIRED</p>

                            {loginStep === 1 ? (
                                <div className="space-y-4">
                                    <div className="relative">
                                        <input 
                                            value={phone} 
                                            onChange={e => setPhone(e.target.value)} 
                                            className="w-full bg-black/40 border border-white/10 rounded-xl p-4 pl-4 text-white placeholder-gray-600 transition-all"
                                            placeholder="+55..." 
                                        />
                                    </div>
                                    <button 
                                        onClick={() => handleLogin('phone')}
                                        disabled={loginLoading}
                                        className="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-orange-900/40 active:scale-95 disabled:opacity-50"
                                    >
                                        {loginLoading ? 'PROCESSANDO...' : 'ENVIAR C√ìDIGO'}
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-4 animate-enter">
                                    <input 
                                        value={code} 
                                        onChange={e => setCode(e.target.value)} 
                                        className="w-full bg-black/40 border border-white/10 rounded-xl p-4 text-center text-2xl tracking-[0.5em] text-white font-tech transition-all"
                                        placeholder="00000" 
                                        type="number"
                                    />
                                    <button 
                                        onClick={() => handleLogin('code')}
                                        disabled={loginLoading}
                                        className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-green-900/40 active:scale-95 disabled:opacity-50"
                                    >
                                        {loginLoading ? 'VALIDANDO...' : 'CONFIRMAR ACESSO'}
                                    </button>
                                    <div className="text-center mt-4">
                                        <button onClick={() => setLoginStep(1)} className="text-xs text-gray-500 hover:text-white transition-colors">Voltar</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // --- RENDER: INTERFACE PRINCIPAL ---
            return (
                <div className="flex flex-col h-screen relative z-10">
                    <ParticleBackground />
                    
                    {/* Header Flutuante */}
                    <header className="fixed top-0 left-0 right-0 p-4 z-40 flex justify-center">
                        <div className="glass px-6 py-3 rounded-full flex items-center gap-4 shadow-2xl">
                            <div className="flex items-center gap-2">
                                <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_10px_#22c55e]"></span>
                                <h1 className="font-bold text-sm tracking-widest font-tech text-gray-200">JARVIS OS</h1>
                            </div>
                            <div className="h-4 w-px bg-white/20"></div>
                            <button onClick={openCam} className="text-gray-300 hover:text-white transition-colors">üì∑</button>
                            <button onClick={() => { localStorage.removeItem('jarvis_auth_v2'); window.location.reload(); }} className="text-xs text-red-400 hover:text-red-300">SAIR</button>
                        </div>
                    </header>

                    {/* √Årea de Chat */}
                    <div className="flex-1 overflow-y-auto pt-24 pb-32 px-4 space-y-4 no-scrollbar">
                        {msg.map((m, i) => (
                            <div key={i} className={`flex ${m.t === 'u' ? 'justify-end' : 'justify-start'} animate-enter`}>
                                <div className={`max-w-[85%] p-4 rounded-2xl text-sm md:text-base leading-relaxed shadow-lg backdrop-blur-sm ${
                                    m.t === 'u' 
                                    ? 'bg-gradient-to-br from-orange-600 to-orange-700 text-white rounded-tr-none' 
                                    : 'glass text-gray-100 rounded-tl-none border-l-2 border-orange-500'
                                }`}>
                                    {m.m}
                                </div>
                            </div>
                        ))}
                        {loading && (
                            <div className="flex justify-start animate-enter">
                                <div className="glass px-4 py-2 rounded-full text-xs text-orange-400 flex items-center gap-2">
                                    <span className="animate-spin">‚ü≥</span> Processando dados...
                                </div>
                            </div>
                        )}
                        <div ref={msgEndRef} />
                    </div>

                    {/* Footer Flutuante (Input) */}
                    <div className="fixed bottom-6 left-0 right-0 px-4 z-40">
                        <div className="max-w-3xl mx-auto glass p-2 rounded-[2rem] flex items-center gap-2 shadow-2xl border border-white/10">
                            <button 
                                onClick={toggleMic}
                                className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${
                                    listening 
                                    ? 'bg-red-500/80 shadow-[0_0_20px_rgba(239,68,68,0.5)] scale-110' 
                                    : 'bg-white/5 hover:bg-white/10'
                                }`}
                            >
                                <span className="text-xl">üéôÔ∏è</span>
                            </button>
                            
                            <input 
                                value={input} 
                                onChange={e => setInput(e.target.value)} 
                                onKeyPress={e => e.key === 'Enter' && 
