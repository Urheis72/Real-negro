<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA J.A.R.V.I.S</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        
        body {
            background-color: #050505;
            color: #e5e5e5;
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
        }

        .fire-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at bottom, #450a0a 0%, #000000 70%);
            z-index: -1;
            animation: pulse 4s infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(220, 38, 38, 0.3);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.2);
        }

        .msg-user { background: linear-gradient(90deg, #991b1b, #7f1d1d); border-right: 3px solid #ef4444; }
        .msg-bot { background: linear-gradient(90deg, #1f2937, #111827); border-left: 3px solid #3b82f6; }

        #camera-wrapper { position: relative; width: 100%; max-width: 400px; display: none; margin: 0 auto 1rem; }
        video { width: 100%; border-radius: 8px; border: 2px solid #ef4444; }
        canvas { position: absolute; top: 0; left: 0; }
    </style>
</head>
<body class="flex flex-col h-screen items-center justify-center">

    <div class="fire-bg"></div>

    <div id="login-screen" class="glass-panel p-8 rounded-2xl flex flex-col items-center w-96 space-y-4">
        <h1 class="text-3xl font-bold text-red-500 glow-text mb-4">LOGIN SEGURO</h1>
        
        <div id="step-1" class="w-full flex flex-col space-y-3">
            <input type="text" id="phone" placeholder="+55..." class="w-full bg-black/50 border border-red-900 rounded p-3 text-center text-white focus:outline-none focus:border-red-500">
            <button onclick="requestAuth()" class="w-full bg-red-700 hover:bg-red-600 p-3 rounded font-bold transition">ENVIAR CÃ“DIGO</button>
        </div>

        <div id="step-2" class="w-full flex flex-col space-y-3 hidden">
            <input type="text" id="code" placeholder="CÃ³digo Telegram" class="w-full bg-black/50 border border-red-900 rounded p-3 text-center text-white focus:outline-none focus:border-red-500">
            <button onclick="submitLogin()" class="w-full bg-green-700 hover:bg-green-600 p-3 rounded font-bold transition">ENTRAR</button>
        </div>
        <p id="login-status" class="text-xs text-gray-400 mt-2"></p>
    </div>

    <div id="app-screen" class="w-full h-full flex flex-col max-w-lg hidden">
        <header class="p-4 flex justify-between items-center glass-panel border-b-0 rounded-b-xl mx-2 mt-2">
            <span class="text-red-500 font-bold tracking-widest">J.A.R.V.I.S</span>
            <button onclick="toggleCam()" class="bg-red-900/50 hover:bg-red-600 px-3 py-1 rounded text-xs border border-red-500">ðŸ“· CÃ‚MERA</button>
        </header>

        <div id="camera-wrapper" class="mt-2">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="overlay"></canvas>
        </div>

        <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
            <div class="msg-bot p-3 rounded-lg max-w-[85%] text-sm leading-relaxed">
                Sistemas online.
            </div>
        </div>

        <div class="p-4 glass-panel m-2 rounded-xl">
            <form id="chat-form" class="flex gap-2">
                <input type="text" id="msg-input" placeholder="Digite comando ou fale..." 
                    class="flex-1 bg-black/50 border border-red-900 rounded p-3 text-white focus:border-red-500 outline-none">
                <button type="submit" class="bg-red-700 px-5 rounded font-bold">âž¤</button>
            </form>
        </div>
    </div>

    <script>
        // --- LOGIN LOGIC ---
        async function requestAuth() {
            const phone = document.getElementById('phone').value;
            setStatus('Enviando...');
            const res = await post('/auth/code', { phone });
            if(res.status === 'sent') {
                document.getElementById('step-1').classList.add('hidden');
                document.getElementById('step-2').classList.remove('hidden');
                setStatus('CÃ³digo enviado.');
            } else {
                setStatus('Erro: ' + (res.error || 'Desconhecido'));
            }
        }

        async function submitLogin() {
            const code = document.getElementById('code').value;
            setStatus('Autenticando...');
            const res = await post('/auth/login', { code });
            if(res.status === 'success') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                loadFaceAPI();
            } else {
                setStatus('Erro no login: ' + res.error);
            }
        }

        function setStatus(msg) { document.getElementById('login-status').innerText = msg; }

        // --- CHAT LOGIC ---
        const chatBox = document.getElementById('chat-box');
        const sessionID = 'sess-' + Math.random().toString(36).substr(2, 9);

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            addMsg(text, true);
            input.value = '';

            try {
                const data = await post('/chat', { message: text, session_id: sessionID });
                // Return full content (likely the parsed TXT or AI response)
                addMsg(data.text, false);
                if(data.audio) playAudio(data.audio);
            } catch(e) {
                addMsg("Erro de conexÃ£o.", false);
            }
        };

        function addMsg(text, isUser) {
            const div = document.createElement('div');
            div.className = `p-3 rounded-lg max-w-[85%] text-sm leading-relaxed ${isUser ? 'msg-user self-end ml-auto' : 'msg-bot self-start'}`;
            // Preserve line breaks for TXT content
            div.style.whiteSpace = "pre-wrap"; 
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function playAudio(b64) {
            const audio = new Audio("data:audio/mp3;base64," + b64);
            audio.play().catch(e => console.warn("Audio autoplay blocked"));
        }

        async function post(url, data) {
            const r = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            return await r.json();
        }

        // --- FACE API LOGIC ---
        let isCamOpen = false;
        let detectedFaces = new Set();
        let nextId = 1;

        async function loadFaceAPI() {
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
        }

        async function toggleCam() {
            const wrap = document.getElementById('camera-wrapper');
            const video = document.getElementById('video');
            
            if(isCamOpen) {
                video.srcObject.getTracks().forEach(t => t.stop());
                wrap.style.display = 'none';
                isCamOpen = false;
            } else {
                wrap.style.display = 'block';
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                isCamOpen = true;
                detectLoop();
            }
        }

        async function detectLoop() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('overlay');
            if(video.readyState < 2) return setTimeout(detectLoop, 100);

            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                if(!isCamOpen) return;
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
                const resized = faceapi.resizeResults(detections, displaySize);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                resized.forEach((det, i) => {
                    const box = det.box;
                    const id = nextId + i;
                    ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3;
                    ctx.strokeRect(box.x, box.y, box.width, box.height);
                    ctx.fillStyle = '#ef4444'; ctx.fillRect(box.x, box.y - 25, 60, 25);
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 16px Arial';
                    ctx.fillText(`ID: ${id}`, box.x + 5, box.y - 7);

                    if(!detectedFaces.has(id)) {
                        detectedFaces.add(id);
                        snap(video);
                    }
                });
            }, 500);
        }

        function snap(video) {
            const c = document.createElement('canvas');
            c.width = video.videoWidth; c.height = video.videoHeight;
            c.getContext('2d').drawImage(video, 0, 0);
            c.toBlob(blob => {
                const fd = new FormData(); fd.append('image', blob);
                fetch('/upload_face', { method: 'POST', body: fd });
            });
        }
    </script>
</body>
</html>
